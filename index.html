<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Curefly Global - Find World-Class Healthcare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .hospital-card { transition: transform 0.2s, box-shadow 0.2s; }
    .hospital-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .star-rating { color: #fbbf24; }
    #loaderStatus { padding: 10px; border-radius: 8px; background: #fff; box-shadow: 0 6px 20px rgba(0,0,0,0.05); margin-bottom: 12px; }
  </style>
</head>

<body class="h-full bg-gradient-to-br from-blue-50 to-white font-sans">
  <header class="bg-white shadow-lg border-b-4 border-blue-600">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <h1 class="text-3xl font-bold text-blue-900">Curefly Global</h1>
          <p class="text-lg text-blue-700 mt-1">Find World-Class Healthcare</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="text-center">
            <p class="text-sm text-gray-600">Local Helpdesk</p>
            <p class="text-lg font-semibold text-blue-900">+91-11-4567-8900</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-gray-600">International Helpdesk</p>
            <p class="text-lg font-semibold text-green-700">+1-800-123-4567</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="loaderStatus" class="bg-white rounded p-4 mb-6">
      <strong>Data loader:</strong> <span id="loaderText">Initializing...</span>
      <div class="text-xs text-gray-500 mt-2" id="loaderHint">If data doesn't load, check Console for details.</div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Search NABH Accredited Hospitals</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">Select City</label>
          <select id="city-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="">Choose a city...</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Specialty (Optional)</label>
          <select id="specialty-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="">All Specialties</option>
          </select>
        </div>

        <div class="flex items-end">
          <button id="search-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg">
            Search Hospitals
          </button>
        </div>
      </div>
    </div>

    <div id="results-section" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-900">Search Results</h3>
        <span id="results-count" class="text-gray-600"></span>
      </div>
      <div id="hospitals-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
    </div>

    <div id="no-results" class="hidden text-center py-12">
      <p class="text-gray-500 text-lg">No hospitals found.</p>
    </div>
  </main>

  <div id="hospital-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90%] overflow-y-auto p-6">
      <div class="flex justify-between items-start mb-4">
        <h2 id="modal-hospital-name" class="text-2xl font-bold"></h2>
        <button id="close-modal" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Robust loader script: tries module import, global var, and JSON fallback -->
  <script type="module">
    const loaderText = document.getElementById('loaderText');

    function logStatus(msg) {
      console.info('[NABH LOADER]', msg);
      loaderText.textContent = msg;
    }
    function logWarn(msg) { console.warn('[NABH LOADER]', msg); }
    function logError(msg) { console.error('[NABH LOADER]', msg); }

    // Try several candidate filenames (raw name + encoded)
    const candidatePaths = [
      './nabh_hospitals_full.js',
      './nabh_hospitals_full%20(1).js',
      './nabh_hospitals_full%20(1).mjs',
      './nabh_hospitals_full%20(1).js',
      './nabh_hospitals_full%20(1).json',
      './nabh_hospitals_full.json',
      './nabh_google_enriched.json'
    ];

    // Try dynamic import (module) for each candidate until one works.
    async function tryDynamicImport(paths) {
      for (const p of paths) {
        try {
          logStatus(`Trying module import: ${p}`);
          const mod = await import(p + '?t=' + Date.now());
          // if module exports `hospitals` or default
          if (mod && (mod.hospitals || mod.default)) {
            const arr = mod.hospitals || mod.default;
            if (Array.isArray(arr)) {
              logStatus(`Loaded hospitals from module: ${p}`);
              return arr;
            }
          }
        } catch (err) {
          // import failed — log and continue
          logWarn(`Import failed for ${p} — ${err && err.message ? err.message : err}`);
        }
      }
      return null;
    }

    // Try loading as a plain script which may define window.nabhHospitals
    function tryLoadAsScript(paths, timeoutMs = 3000) {
      return new Promise((resolve) => {
        let loaded = false;
        let tried = 0;

        function tryNext() {
          if (tried >= paths.length) {
            if (!loaded) resolve(null);
            return;
          }
          const p = paths[tried++];
          logStatus(`Trying to add script tag: ${p}`);
          const s = document.createElement('script');
          s.src = p + '?t=' + Date.now();
          s.async = true;
          s.onload = () => {
            logStatus(`Script loaded: ${p}`);
            // check global
            if (window.nabhHospitals && Array.isArray(window.nabhHospitals)) {
              loaded = true;
              logStatus(`Found window.nabhHospitals after loading ${p}`);
              resolve(window.nabhHospitals);
            } else {
              // maybe file had export (module) and didn't attach — continue trying others
              setTimeout(tryNext, 100);
            }
          };
          s.onerror = (e) => {
            logWarn(`Script error loading ${p}`);
            setTimeout(tryNext, 50);
          };
          document.head.appendChild(s);
        }

        tryNext();

        // safety fallback after timeout
        setTimeout(() => {
          if (!loaded) {
            logWarn('Script-tag loader timed out; no window.nabhHospitals found.');
            resolve(null);
          }
        }, timeoutMs + paths.length * 200);
      });
    }

    // Try fetch JSON fallback
    async function tryFetchJson(paths) {
      for (const p of paths) {
        // only try .json candidates
        if (!p.endsWith('.json')) continue;
        try {
          logStatus(`Trying fetch JSON: ${p}`);
          const r = await fetch(p + '?t=' + Date.now(), { cache: 'no-store' });
          if (!r.ok) { logWarn(`Fetch failed ${p} status ${r.status}`); continue; }
          const arr = await r.json();
          if (Array.isArray(arr)) {
            logStatus(`Loaded hospitals from JSON: ${p}`);
            return arr;
          }
        } catch (err) {
          logWarn(`Fetch JSON error ${p} — ${err && err.message}`);
        }
      }
      return null;
    }

    // Main loader: tries (1) dynamic import (module), (2) script tag global, (3) fetch JSON
    async function loadNabh() {
      try {
        // First — module import for .js/.mjs candidates
        const moduleCandidates = candidatePaths.filter(p => p.endsWith('.js') || p.endsWith('.mjs'));
        let arr = await tryDynamicImport(moduleCandidates);
        if (arr && Array.isArray(arr)) return arr;

        // Second — try script tag to pick up window.nabhHospitals
        arr = await tryLoadAsScript(moduleCandidates);
        if (arr && Array.isArray(arr)) return arr;

        // Third — try fetch JSON
        arr = await tryFetchJson(candidatePaths);
        if (arr && Array.isArray(arr)) return arr;

        // Nothing worked
        logError('Could not load NABH dataset. Please check filenames and ensure files are in repo root.');
        logError('Expected one of: ' + JSON.stringify(candidatePaths));
        return [];
      } catch (err) {
        logError('Unexpected loader error: ' + (err && err.message || err));
        return [];
      }
    }

    // UI wiring (keeps Canva look)
    const citySelect = document.getElementById('city-select');
    const specialtySelect = document.getElementById('specialty-select');
    const searchBtn = document.getElementById('search-btn');
    const hospitalsGrid = document.getElementById('hospitals-grid');
    const resultsSection = document.getElementById('results-section');
    const noResults = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');
    const modal = document.getElementById('hospital-modal');
    const modalName = document.getElementById('modal-hospital-name');
    const modalContent = document.getElementById('modal-content');

    function normalizeKey(s) { return (s || '').toString().trim().toLowerCase(); }

    function buildIndex(arr) {
      const map = {};
      arr.forEach((h, i) => {
        const cityKey = normalizeKey(h.city || h.city_name || h.state || 'unknown');
        if (!map[cityKey]) map[cityKey] = [];
        // keep raw object but ensure minimal fields
        map[cityKey].push(Object.assign({
          id: 'nabh-' + (h.certId || i),
          name: h.name || h.hospital_name || 'Unnamed',
          city: h.city || '',
          international_phone: h.international_phone || h.phone || '',
          surgeryPackages: h.surgeryPackages || h.surgeries || []
        }, h));
      });
      return map;
    }

    function populateCitySelect(map) {
      // clear existing except placeholder
      Array.from(citySelect.options).slice(1).forEach(opt => opt.remove());
      Object.keys(map).sort().forEach(cityKey => {
        const opt = document.createElement('option');
        opt.value = cityKey;
        opt.textContent = cityKey.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        citySelect.appendChild(opt);
      });
      // ensure Kolkata exists
      if (!Object.keys(map).includes('kolkata')) {
        const opt = document.createElement('option');
        opt.value = 'kolkata';
        opt.textContent = 'Kolkata';
        citySelect.appendChild(opt);
      }
    }

    function showNoResults() {
      resultsSection.classList.add('hidden');
      noResults.classList.remove('hidden');
    }
    function showResults(list) {
      noResults.classList.add('hidden');
      resultsSection.classList.remove('hidden');
      resultsCount.textContent = `${list.length} hospital(s) found`;
      hospitalsGrid.innerHTML = list.map(h => {
        const nameEsc = (h.name || '').replace(/'/g, "\\'");
        return `
          <div class="hospital-card bg-white rounded-lg shadow-md p-6 cursor-pointer" data-name="${nameEsc}">
            <div class="flex justify-between mb-3">
              <div>
                <h3 class="text-xl font-bold">${h.name}</h3>
                <p class="text-sm text-gray-600">${h.city || ''}</p>
              </div>
            </div>
            <div class="text-sm text-gray-600">${(h.address || '')}</div>
            <div class="mt-4">
              <button class="open-details text-blue-600 font-medium">View Details →</button>
            </div>
          </div>
        `;
      }).join('');
      // attach handlers
      document.querySelectorAll('.hospital-card .open-details').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('.hospital-card');
          const name = card.getAttribute('data-name');
          openModal(name);
        });
      });
    }

    function openModal(name) {
      const all = Object.values(window._hospitalIndex || {}).flat();
      const h = all.find(x => x.name === name || x.id === name);
      if (!h) return;
      modalName.textContent = h.name || 'Hospital';
      const phones = h.international_phone || h.phone || 'Not provided';
      const surgeriesHtml = (h.surgeryPackages || []).map(s => `<div class="bg-blue-50 p-3 rounded mb-2"><strong>${s.name || s.title || ''}</strong><div class="text-blue-600">${s.cost || s.price || ''}</div></div>`).join('') || '<p class="text-gray-600">Not provided</p>';
      modalContent.innerHTML = `
        <p><strong>City:</strong> ${h.city || ''}</p>
        <p><strong>Phone:</strong> ${phones}</p>
        <h4 class="mt-4 font-semibold">Surgeries</h4>
        ${surgeriesHtml}
      `;
      modal.classList.remove('hidden');
    }

    document.getElementById('close-modal').addEventListener('click', () => modal.classList.add('hidden'));
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

    // hook search button
    searchBtn.addEventListener('click', () => {
      const cityKey = normalizeKey(citySelect.value || '');
      if (!cityKey) { showNoResults(); return; }
      const list = (window._hospitalIndex && window._hospitalIndex[cityKey]) || [];
      if (!list.length) { showNoResults(); return; }
      showResults(list);
    });

    // initialization
    (async () => {
      logStatus('Starting dataset load...');
      const arr = await loadNabh();
      if (!arr || !arr.length) {
        logError('Dataset not found or empty. See console for candidate paths and errors.');
        document.getElementById('loaderHint').textContent = 'No dataset loaded. Please upload a file named "nabh_hospitals_full.js" or "nabh_google_enriched.json" in repo root. Check Console for details.';
        return;
      }
      logStatus(`Loaded ${arr.length} hospital records.`);
      // build index and attach to window for debug
      const index = buildIndex(arr);
      window._hospitalIndex = index;
      populateCitySelect(index);
      logStatus('Ready — choose a city and click Search.');
    })();
  </script>
</body>
</html>
